generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id               String   @id @default(cuid())
  name             String
  appName          String   @default("BuildFlo")
  logo             String?
  website          String?
  phone            String?
  email            String?
  address          String?
  city             String?
  state            String?
  zipCode          String?
  country          String?
  currency         String   @default("USD")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  users            User[]
  stages           Stage[]
  cards            Card[]
  estimateItems    EstimateItem[]
  bidRequests      BidRequest[]
  teamInvites      TeamInvite[]
  projectTemplates ProjectTemplate[]
  vendors          Vendor[]
  assets           Asset[]
  procurementItems ProcurementItem[]
  stockAlertConfigs StockAlertConfig[]
  emailConfig      EmailConfig?
  purchaseOrders   PurchaseOrder[]
  inventoryCategories InventoryCategory[]
  inventoryMaterials  InventoryMaterial[]
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  firstName        String
  lastName         String
  phone            String?
  avatar           String?
  role             Role     @default(STAFF)
  isActive         Boolean  @default(true)
  lastLogin        DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  companyId        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cards            Card[]   @relation("CardOwner")
  assignedCards    Card[]   @relation("AssignedUsers")
  tasks            Task[]   @relation("TaskAssignee")
  createdTasks     Task[]   @relation("TaskCreator")
  approvedTasks    Task[]   @relation("TaskCompletionApprover")
  activities       Activity[]
  documents        Document[]
  messages         Message[]
  dailyLogs        DailyLog[]
  notifications    Notification[]
  bidRequests      BidRequest[]
  bidDocuments     BidDocument[]
  notificationPreference NotificationPreference?
  teamInvites      TeamInvite[]
  walkarounds      Walkaround[]
  taskComments     TaskComment[]
  taskMentions     TaskCommentMention[]
  vendorComments   VendorComment[] @relation("VendorCommentAuthor")
  vendorCommentMentions VendorCommentMention[] @relation("VendorCommentMentions")
  vendorReviews    VendorReview[]
  taskAttachments  TaskAttachment[]
  taskPayments     TaskPayment[]
  contractPayments ContractPayment[]

  // Asset Management relations
  currentAssets         Asset[]             @relation("AssetCurrentAssignee")
  assetRequests         AssetRequest[]      @relation("AssetRequester")
  assetApprovals        AssetRequest[]      @relation("AssetApprover")
  assetRejections       AssetRequest[]      @relation("AssetRejector")
  maintenanceAssignments MaintenanceSchedule[] @relation("MaintenanceAssignee")
  maintenanceRecords    MaintenanceRecord[] @relation("MaintenancePerformer")

  // Procurement & Inventory relations
  inventoryPurchases    InventoryPurchase[]
  inventoryUsages       InventoryUsage[]

  // Purchase Order relations
  createdPurchaseOrders   PurchaseOrder[]     @relation("POCreator")
  approvedPurchaseOrders  PurchaseOrder[]     @relation("POApprover")

  // Project Milestones
  createdMilestones     ProjectMilestone[]

  // BOQ relations
  createdBOQItems       BOQItem[]        @relation("BOQCreator")
  createdBOQRevisions   BOQRevision[]    @relation("BOQRevisionCreator")

  // Inventory Management
  inventoryTransactions InventoryTransaction[]

  @@index([email])
  @@index([companyId])
}

enum Role {
  ADMIN
  STAFF
  SUBCONTRACTOR
  CLIENT
}

model Stage {
  id               String   @id @default(cuid())
  name             String
  color            String
  order            Int
  companyId        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cards            Card[]
  
  @@unique([companyId, order])
  @@index([companyId])
}

model Card {
  id               String   @id @default(cuid())
  title            String
  description      String?
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  projectAddress   String?
  projectCity      String?
  projectState     String?
  projectZipCode   String?
  projectSize      Float?
  projectSizeUnit  String?
  budget           Float?
  timeline         String?
  startDate        DateTime?
  endDate          DateTime?
  priority         Priority @default(MEDIUM)
  status           CardStatus @default(ACTIVE)
  customFields     String?  // JSON string for flexible fields
  stageId          String
  companyId        String
  ownerId          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  stage            Stage    @relation(fields: [stageId], references: [id])
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner            User?    @relation("CardOwner", fields: [ownerId], references: [id])
  assignedUsers    User[]   @relation("AssignedUsers")
  tasks            Task[]
  taskCategories   TaskCategory[]
  folders          Folder[]
  documents        Document[]
  budgetItems      BudgetItem[]
  estimates        Estimate[]
  activities       Activity[]
  messages         Message[]
  feedback         Feedback[]
  dailyLogs        DailyLog[]
  walkarounds      Walkaround[]
  bidRequests      BidRequest[]
  clientPortalSettings ClientPortalSettings?
  projectVendors   ProjectVendor[]
  vendorReviews    VendorReview[]
  projectContracts ProjectContract[]
  assetRequests    AssetRequest[]
  inventoryEntries InventoryEntry[]
  projectMilestones ProjectMilestone[]
  purchaseOrders   PurchaseOrder[]
  boqItems         BOQItem[]
  boqRevisions     BOQRevision[]
  inventoryAllocations InventoryTransaction[] @relation("InventoryProjectAllocation")

  @@index([stageId])
  @@index([companyId])
  @@index([ownerId])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CardStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
  CANCELLED
}

model TaskCategory {
  id               String   @id @default(cuid())
  name             String
  description      String?
  color            String   @default("#6366f1")
  order            Int      @default(0)
  cardId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  tasks            Task[]
  
  @@index([cardId])
  @@unique([cardId, name])
}

model Task {
  id               String   @id @default(cuid())
  title            String
  description      String?
  dueDate          DateTime?
  status           TaskStatus @default(TODO)
  priority         Priority @default(MEDIUM)
  isRecurring      Boolean  @default(false)
  recurringPattern String?  // JSON for recurring settings
  cardId           String
  categoryId       String?
  assigneeId       String?
  creatorId        String
  completedAt      DateTime?
  archivedAt       DateTime?
  isArchived       Boolean  @default(false)
  order            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Sharing fields
  shareToken       String?  @unique
  isShareable      Boolean  @default(false)
  sharedAt         DateTime?
  sharedBy         String?

  // Budget fields (internal only - not visible to vendors)
  budgetAmount     Float?
  approvedAmount   Float?
  // costVariance computed as: budgetAmount - approvedAmount

  // Escalation fields
  isEscalated      Boolean  @default(false)
  escalatedAt      DateTime?
  escalatedBy      String?
  escalationReason String?

  // Vendor assignment
  vendorId         String?

  // Milestone assignment
  milestoneId      String?

  // Completion approval workflow (for vendor-assigned tasks)
  completionPendingApproval Boolean   @default(false)
  completionRequestedAt     DateTime?
  completionApprovedAt      DateTime?
  completionApprovedById    String?

  card             Card         @relation(fields: [cardId], references: [id], onDelete: Cascade)
  category         TaskCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  assignee         User?        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator          User         @relation("TaskCreator", fields: [creatorId], references: [id])
  completionApprover User?      @relation("TaskCompletionApprover", fields: [completionApprovedById], references: [id])
  vendor           Vendor?      @relation("TaskVendor", fields: [vendorId], references: [id])
  milestone        ProjectMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  interactions     TaskInteraction[]
  comments         TaskComment[]
  attachments      TaskAttachment[]
  payments         TaskPayment[]

  // Task dependencies - many-to-many self-relation
  dependsOn        Task[]       @relation("TaskDependencies")
  dependents       Task[]       @relation("TaskDependencies")

  @@index([cardId])
  @@index([categoryId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([shareToken])
  @@index([vendorId])
  @@index([milestoneId])
  @@index([isEscalated])
  @@index([completionPendingApproval])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  OVERDUE
  COMPLETED
  CANCELLED
}

model Folder {
  id               String   @id @default(cuid())
  name             String
  description      String?
  color            String   @default("#6366f1")
  parentId         String?
  cardId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  parent           Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         Folder[] @relation("FolderHierarchy")
  documents        Document[]
  
  @@index([cardId])
  @@index([parentId])
  @@unique([cardId, name, parentId])
}

model Document {
  id               String   @id @default(cuid())
  name             String
  fileName         String
  fileSize         Int
  mimeType         String
  url              String
  folderId         String?
  isShared         Boolean  @default(false)
  shareLink        String?  @unique
  shareLinkExpiry  DateTime?
  cardId           String
  uploaderId       String
  version          Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  folder           Folder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)
  uploader         User     @relation(fields: [uploaderId], references: [id])
  
  @@index([cardId])
  @@index([folderId])
  @@index([shareLink])
}

model BudgetItem {
  id               String   @id @default(cuid())
  name             String
  description      String?
  category         String
  amount           Float
  quantity         Float    @default(1)
  unit             String?
  isExpense        Boolean  @default(true)
  isPaid           Boolean  @default(false)
  paidAt           DateTime?
  cardId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  @@index([cardId])
}

model Estimate {
  id               String   @id @default(cuid())
  estimateNumber   String   @unique
  title            String
  description      String?
  subtotal         Float
  tax              Float    @default(0)
  discount         Float    @default(0)
  total            Float
  status           EstimateStatus @default(DRAFT)
  validUntil       DateTime?
  sentAt           DateTime?
  viewedAt         DateTime?
  acceptedAt       DateTime?
  rejectedAt       DateTime?
  signature        String?
  signedBy         String?
  notes            String?
  terms            String?
  cardId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  items            EstimateLineItem[]
  
  @@index([cardId])
  @@index([estimateNumber])
}

enum EstimateStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

model EstimateLineItem {
  id               String   @id @default(cuid())
  name             String
  description      String?
  quantity         Float
  unit             String?
  unitPrice        Float
  total            Float
  order            Int
  estimateId       String
  itemTemplateId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  estimate         Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  template         EstimateItem? @relation(fields: [itemTemplateId], references: [id])
  
  @@index([estimateId])
}

model EstimateItem {
  id               String   @id @default(cuid())
  name             String
  description      String?
  category         String
  unitPrice        Float
  unit             String?
  companyId        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lineItems        EstimateLineItem[]
  
  @@index([companyId])
}

model Activity {
  id               String   @id @default(cuid())
  type             String
  description      String
  metadata         String?  // JSON for additional data
  cardId           String
  userId           String
  createdAt        DateTime @default(now())
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id])
  
  @@index([cardId])
  @@index([userId])
}

model Message {
  id               String   @id @default(cuid())
  content          String
  isInternal       Boolean  @default(false)
  isFromClient     Boolean  @default(false)
  isRead           Boolean  @default(false)
  readAt           DateTime?
  clientName       String?  // For messages from clients who aren't users
  clientEmail      String?  // For messages from clients who aren't users
  cardId           String
  senderId         String?  // Nullable for client messages
  parentId         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  sender           User?    @relation(fields: [senderId], references: [id])
  parent           Message? @relation("MessageReplies", fields: [parentId], references: [id])
  replies          Message[] @relation("MessageReplies")
  
  @@index([cardId])
  @@index([senderId])
  @@index([isFromClient])
  @@index([isRead])
}

model Feedback {
  id               String   @id @default(cuid())
  rating           Int?
  comment          String?
  cardId           String
  submittedBy      String
  submittedAt      DateTime @default(now())
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  @@index([cardId])
}

enum NotificationChannel {
  IN_APP
  EMAIL
  BOTH
}

model Notification {
  id               String              @id @default(cuid())
  type             String
  title            String
  message          String
  isRead           Boolean             @default(false)
  metadata         String?             // JSON for action links, etc.
  channel          NotificationChannel @default(IN_APP)
  emailSentAt      DateTime?
  emailError       String?             // Error message if email failed
  userId           String
  createdAt        DateTime            @default(now())

  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

model SubcontractorAccess {
  id               String   @id @default(cuid())
  email            String
  phone            String?
  accessCode       String   @unique
  otpCode          String?
  otpExpiry        DateTime?
  qrCode           String   @unique
  isActive         Boolean  @default(true)
  lastAccess       DateTime?
  projectIds       String   // JSON array of card IDs
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([email])
  @@index([accessCode])
}

model TaskInteraction {
  id               String   @id @default(cuid())
  taskId           String
  action           TaskInteractionAction
  ipAddress        String?
  userAgent        String?
  metadata         String?  // JSON for additional data
  timestamp        DateTime @default(now())
  
  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId])
  @@index([action])
  @@index([timestamp])
}

model TaskComment {
  id               String   @id @default(cuid())
  content          String
  taskId           String
  authorId         String?  // Optional - either authorId or vendorId should be set
  vendorId         String?  // For vendor comments
  parentId         String?  // For threaded replies
  isEdited         Boolean  @default(false)
  editedAt         DateTime?
  deletedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author           User?    @relation(fields: [authorId], references: [id])
  vendor           Vendor?  @relation(fields: [vendorId], references: [id])
  parent           TaskComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies          TaskComment[] @relation("CommentReplies")
  mentions         TaskCommentMention[]

  @@index([taskId])
  @@index([authorId])
  @@index([vendorId])
  @@index([parentId])
  @@index([createdAt])
}

model TaskCommentMention {
  id               String   @id @default(cuid())
  commentId        String
  mentionedUserId  String
  isRead           Boolean  @default(false)
  createdAt        DateTime @default(now())

  comment          TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser    User     @relation(fields: [mentionedUserId], references: [id])

  @@index([commentId])
  @@index([mentionedUserId])
  @@index([isRead])
  @@unique([commentId, mentionedUserId])
}

// Task File Attachments
model TaskAttachment {
  id                   String   @id @default(cuid())
  taskId               String
  fileName             String
  fileSize             Int
  mimeType             String
  url                  String
  uploaderId           String?  // Optional - either uploaderId or uploadedByVendorId should be set
  uploadedByVendorId   String?  // For vendor uploads
  createdAt            DateTime @default(now())

  task                 Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader             User?    @relation(fields: [uploaderId], references: [id])
  uploadedByVendor     Vendor?  @relation(fields: [uploadedByVendorId], references: [id])

  @@index([taskId])
  @@index([uploadedByVendorId])
}

// Task Payments (internal only - tracks payments against approved amounts)
model TaskPayment {
  id               String   @id @default(cuid())
  taskId           String
  amount           Float
  invoiceNumber    String?
  referenceNumber  String?
  paymentDate      DateTime
  notes            String?
  createdById      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdBy        User     @relation(fields: [createdById], references: [id])

  @@index([taskId])
  @@index([paymentDate])
}

model DailyLog {
  id               String   @id @default(cuid())
  date             DateTime @default(now())
  cardId           String
  authorId         String
  
  // Weather information
  weatherCondition String?     // sunny, cloudy, rainy, etc.
  temperature      Float?      // in Fahrenheit
  weatherNotes     String?
  
  // Work information
  workCompleted    String      // Detailed description of work done
  materialsUsed    String?     // Materials used today
  equipment        String?     // Equipment on site
  
  // Workers
  workersOnSite    Int         @default(0)
  workerDetails    String?     // Names/companies of workers
  
  // Issues and delays
  issues           String?     // Any issues encountered
  delays           String?     // Any delays and reasons
  safetyIncidents  String?     // Safety incidents if any
  
  // Photos
  photos           String?     // JSON array of photo URLs
  
  // Additional notes
  notes            String?
  
  // Metadata
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  
  // Relations
  card             Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  author           User        @relation(fields: [authorId], references: [id])
  
  @@index([cardId, date])
  @@index([authorId])
}

enum TaskInteractionAction {
  OPENED
  STARTED
  COMPLETED
  UPDATED
}

model BidRequest {
  id               String   @id @default(cuid())
  title            String
  description      String
  location         String?
  timeline         String?
  requirements     String?
  deadline         DateTime?
  budget           Float?
  shareToken       String   @unique
  isActive         Boolean  @default(true)
  cardId           String   // Link to specific project
  companyId        String
  creatorId        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator          User     @relation(fields: [creatorId], references: [id])
  bids             Bid[]
  documents        BidDocument[]
  views            BidView[]
  
  @@index([cardId])
  @@index([companyId])
  @@index([creatorId])
  @@index([shareToken])
  @@index([deadline])
}

model Bid {
  id               String   @id @default(cuid())
  bidRequestId     String
  companyName      String
  contactName      String
  contactEmail     String
  contactPhone     String?
  licenseNumber    String?
  insuranceInfo    String?
  subtotal         Float?
  tax              Float?
  discount         Float?
  totalAmount      Float?
  notes            String?
  timeline         String?
  warranty         String?
  paymentTerms     String?
  lineItems        String?  // JSON for line items (temporary - will migrate to BidItem)
  hasUploadedFile  Boolean  @default(false)
  fileName         String?
  fileUrl          String?
  ipAddress        String?
  userAgent        String?
  status           BidStatus @default(SUBMITTED)
  submittedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  bidRequest       BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)
  items            BidItem[]
  
  @@index([bidRequestId])
  @@index([status])
  @@index([submittedAt])
}

model BidItem {
  id               String   @id @default(cuid())
  bidId            String
  name             String
  description      String?
  quantity         Float
  unit             String
  unitPrice        Float
  total            Float
  order            Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  bid              Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  
  @@index([bidId])
}

model BidDocument {
  id               String   @id @default(cuid())
  bidRequestId     String
  name             String
  fileName         String
  fileSize         Int
  mimeType         String
  url              String
  uploadedById     String
  createdAt        DateTime @default(now())
  
  bidRequest       BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)
  uploadedBy       User     @relation(fields: [uploadedById], references: [id])
  
  @@index([bidRequestId])
}

model BidView {
  id               String   @id @default(cuid())
  bidRequestId     String
  ipAddress        String?
  userAgent        String?
  viewedAt         DateTime @default(now())
  
  bidRequest       BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)
  
  @@index([bidRequestId])
  @@index([viewedAt])
}

enum BidStatus {
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique

  // Channel preferences
  emailEnabled         Boolean  @default(true)
  inAppEnabled         Boolean  @default(true)

  // Due date notification timing
  dueDateReminder2Day  Boolean  @default(true)
  dueDateReminder1Day  Boolean  @default(true)
  overdueReminderDaily Boolean  @default(true)

  // Email notifications
  emailNewLead         Boolean  @default(true)
  emailProjectUpdate   Boolean  @default(true)
  emailTaskAssigned    Boolean  @default(true)
  emailTaskCompleted   Boolean  @default(true)
  emailBidReceived     Boolean  @default(true)
  emailBidStatusChange Boolean  @default(true)
  emailTaskEscalated   Boolean  @default(true)
  emailLowStock        Boolean  @default(true)

  // Push notifications (in-app)
  pushNewLead          Boolean  @default(false)
  pushProjectUpdate    Boolean  @default(true)
  pushTaskAssigned     Boolean  @default(true)
  pushTaskCompleted    Boolean  @default(false)
  pushBidReceived      Boolean  @default(true)
  pushBidStatusChange  Boolean  @default(true)
  pushTaskEscalated    Boolean  @default(true)
  pushLowStock         Boolean  @default(true)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TeamInvite {
  id               String   @id @default(cuid())
  email            String
  firstName        String
  lastName         String
  role             Role     @default(STAFF)
  token            String   @unique
  companyId        String
  invitedById      String
  expiresAt        DateTime
  isAccepted       Boolean  @default(false)
  acceptedAt       DateTime?
  createdAt        DateTime @default(now())
  
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invitedBy        User     @relation(fields: [invitedById], references: [id])
  
  @@index([token])
  @@index([email])
  @@index([companyId])
}

model ProjectTemplate {
  id               String   @id @default(cuid())
  name             String
  description      String?
  icon             String?  // emoji or icon identifier
  
  // Template fields that map to Card model
  title            String?
  projectDescription String?
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  projectAddress   String?
  projectCity      String?
  projectState     String?
  projectZipCode   String?
  projectSize      Float?
  projectSizeUnit  String?
  budget           Float?
  timeline         String?
  priority         Priority @default(MEDIUM)
  customFields     String?  // JSON string for flexible fields
  
  // Company association
  companyId        String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  taskCategories   ProjectTemplateCategory[]
  folders          ProjectTemplateFolder[]
  budgetItems      ProjectTemplateBudget[]
  
  @@index([companyId])
  @@unique([companyId, name])
}

model ProjectTemplateCategory {
  id               String   @id @default(cuid())
  name             String
  description      String?
  color            String   @default("#6366f1")
  order            Int      @default(0)
  templateId       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  template         ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tasks            ProjectTemplateTask[]
  
  @@index([templateId])
  @@unique([templateId, name])
}

model ProjectTemplateTask {
  id               String   @id @default(cuid())
  title            String
  description      String?
  priority         Priority @default(MEDIUM)
  daysFromStart    Int?     // Number of days from project start date
  categoryId       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  category         ProjectTemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([categoryId])
}

model ProjectTemplateFolder {
  id               String   @id @default(cuid())
  name             String
  description      String?
  color            String   @default("#6366f1")
  parentId         String?
  templateId       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  template         ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  parent           ProjectTemplateFolder? @relation("TemplateFolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         ProjectTemplateFolder[] @relation("TemplateFolderHierarchy")
  
  @@index([templateId])
  @@index([parentId])
}

model ProjectTemplateBudget {
  id               String   @id @default(cuid())
  name             String
  description      String?
  category         String
  amount           Float
  quantity         Float    @default(1)
  unit             String?
  isExpense        Boolean  @default(true)
  templateId       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  template         ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@index([templateId])
}

model Walkaround {
  id          String          @id @default(cuid())
  projectId   String
  userId      String
  startTime   DateTime
  endTime     DateTime?
  audioUrl    String?
  transcript  String?
  summary     String?
  reportUrl   String?
  status      WalkaroundStatus @default(IN_PROGRESS)
  metadata    String?         // JSON for additional data
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  project     Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id])
  photos      WalkaroundPhoto[]
  
  @@index([projectId])
  @@index([userId])
  @@index([status])
}

model WalkaroundPhoto {
  id           String      @id @default(cuid())
  walkaroundId String
  url          String
  thumbnailUrl String?
  timestamp    DateTime
  location     String?     // JSON {lat, lng, accuracy}
  caption      String?
  order        Int         @default(0)
  createdAt    DateTime    @default(now())
  
  walkaround   Walkaround  @relation(fields: [walkaroundId], references: [id], onDelete: Cascade)
  
  @@index([walkaroundId])
}

enum WalkaroundStatus {
  IN_PROGRESS
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

model ClientPortalSettings {
  id                    String   @id @default(cuid())
  projectId             String   @unique
  
  // Project Overview Settings
  showProgress          Boolean  @default(true)
  showTimeline          Boolean  @default(true)
  showBudgetSummary     Boolean  @default(false)
  showProjectDescription Boolean @default(true)
  showTeamMembers       Boolean  @default(true)
  
  // Tasks Settings
  showTasks             Boolean  @default(true)
  showTaskAssignees     Boolean  @default(false)
  showTaskDueDates      Boolean  @default(true)
  showCompletedTasks    Boolean  @default(true)
  hideInternalTasks     Boolean  @default(true)
  
  // Documents & Files Settings
  showDocuments         Boolean  @default(true)
  allowedFileTypes      String?  // JSON array of allowed file extensions
  hideInternalDocuments Boolean  @default(true)
  
  // Estimates & Financial Settings
  showEstimates         Boolean  @default(true)
  showEstimateDetails   Boolean  @default(false)
  showInvoices          Boolean  @default(false)
  showPayments          Boolean  @default(false)
  
  // Communication Settings
  showMessages          Boolean  @default(true)
  showActivityFeed      Boolean  @default(true)
  hideInternalMessages  Boolean  @default(true)
  
  // Additional Settings
  showPhotos            Boolean  @default(true)
  showWalkarounds       Boolean  @default(false)
  customWelcomeMessage  String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  project               Card     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

// Vendor Management Models
model Vendor {
  id                    String          @id @default(cuid())
  name                  String
  companyName           String
  email                 String?
  phone                 String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  website               String?
  licenseNumber         String?
  insuranceInfo         String?
  type                  VendorType      @default(SUPPLY_AND_INSTALLATION)
  status                VendorStatus    @default(PENDING_VERIFICATION)
  scopeOfWork           String?         // Free text area
  paymentTerms          String?         // Free text
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  isActive              Boolean         @default(true)
  notes                 String?
  companyId             String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Vendor Portal Authentication
  portalEmail           String?         @unique
  portalPassword        String?
  portalToken           String?
  portalTokenExpiry     DateTime?
  lastPortalLogin       DateTime?

  company               Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts              VendorContact[]
  projectVendors        ProjectVendor[]
  milestones            VendorMilestone[]
  reviews               VendorReview[]
  contracts             VendorContract[]
  inventoryPurchases    InventoryPurchase[]
  priceComparisons      PriceComparison[]
  tasks                 Task[]          @relation("TaskVendor")
  projectMilestones     ProjectMilestone[]
  preferredForItems     ProcurementItem[] @relation("PreferredVendorItems")
  purchaseOrders        PurchaseOrder[]
  taskComments          TaskComment[]
  taskAttachments       TaskAttachment[]
  comments              VendorComment[] @relation("VendorComments")

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@index([portalEmail])
}

enum VendorType {
  SUPPLY_AND_INSTALLATION
  SUPPLY
  INSTALLATION
}

enum VendorStatus {
  PENDING_VERIFICATION
  VERIFIED
  SUSPENDED
  BLACKLISTED
  INACTIVE
}

// Internal comments on vendors (visible only to company users, not vendors)
model VendorComment {
  id        String    @id @default(cuid())
  content   String
  vendorId  String
  authorId  String
  parentId  String?
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  vendor    Vendor         @relation("VendorComments", fields: [vendorId], references: [id], onDelete: Cascade)
  author    User           @relation("VendorCommentAuthor", fields: [authorId], references: [id])
  parent    VendorComment? @relation("VendorCommentReplies", fields: [parentId], references: [id])
  replies   VendorComment[] @relation("VendorCommentReplies")
  mentions  VendorCommentMention[]

  @@index([vendorId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

model VendorCommentMention {
  id              String   @id @default(cuid())
  commentId       String
  mentionedUserId String
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())

  comment         VendorComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser   User          @relation("VendorCommentMentions", fields: [mentionedUserId], references: [id])

  @@index([commentId])
  @@index([mentionedUserId])
  @@index([isRead])
  @@unique([commentId, mentionedUserId])
}

enum ContractType {
  LUMP_SUM
  REMEASURABLE
  ADDENDUM
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
  EXPIRED
}

model VendorContact {
  id                    String          @id @default(cuid())
  firstName             String
  lastName              String
  email                 String?
  phone                 String?
  position              String?
  isPrimary             Boolean         @default(false)
  isBilling             Boolean         @default(false)
  vendorId              String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  vendor                Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@index([vendorId])
}

model ProjectVendor {
  id                    String          @id @default(cuid())
  projectId             String
  vendorId              String
  assignedScope         String?         // Project-specific scope
  contractValue         Float?
  status                ProjectVendorStatus @default(ASSIGNED)
  assignedAt            DateTime        @default(now())
  completedAt           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  project               Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  vendor                Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  milestones            VendorMilestone[]
  
  @@unique([projectId, vendorId])
  @@index([projectId])
  @@index([vendorId])
}

enum ProjectVendorStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

model VendorMilestone {
  id                    String          @id @default(cuid())
  title                 String
  description           String?
  targetDate            DateTime?
  completedDate         DateTime?
  status                MilestoneStatus @default(PENDING)
  order                 Int
  vendorId              String
  projectVendorId       String?         // Optional - for project-specific milestones
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  vendor                Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  projectVendor         ProjectVendor?  @relation(fields: [projectVendorId], references: [id], onDelete: Cascade)
  
  @@index([vendorId])
  @@index([projectVendorId])
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

// Project-level milestones that can be assigned to vendors
model ProjectMilestone {
  id                    String          @id @default(cuid())
  title                 String
  description           String?
  amount                Float?          // Payment amount for this milestone
  targetDate            DateTime?
  completedDate         DateTime?
  status                MilestoneStatus @default(PENDING)
  order                 Int             @default(0)
  projectId             String
  vendorId              String?         // Optional - can be assigned to a vendor
  createdById           String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  project               Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  vendor                Vendor?         @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  createdBy             User            @relation(fields: [createdById], references: [id])
  tasks                 Task[]

  @@index([projectId])
  @@index([vendorId])
  @@index([status])
}

model VendorReview {
  id                    String          @id @default(cuid())
  overallRating         Float           // 1-5 stars
  qualityRating         Float?          // 1-5 stars
  timelinessRating      Float?          // 1-5 stars
  communicationRating   Float?          // 1-5 stars
  professionalismRating Float?          // 1-5 stars
  comments              String?
  projectId             String?         // Optional - review can be for specific project
  vendorId              String
  reviewerId            String
  isPublic              Boolean         @default(false)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  vendor                Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  project               Card?           @relation(fields: [projectId], references: [id], onDelete: SetNull)
  reviewer              User            @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([projectId])
  @@index([reviewerId])
}

// Vendor Contract Management
model VendorContract {
  id                    String          @id @default(cuid())
  contractNumber        String          @unique
  vendorId              String
  type                  ContractType
  totalSum              Float
  retentionPercent      Float?          @default(0)
  retentionAmount       Float?
  warrantyYears         Int             @default(1) // 1-10 years
  startDate             DateTime
  endDate               DateTime
  status                ContractStatus  @default(DRAFT)
  terms                 String?         // Rich text / contract terms
  notes                 String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  vendor                Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  projects              ProjectContract[]
  documents             ContractDocument[]
  payments              ContractPayment[]

  @@index([vendorId])
  @@index([status])
  @@index([contractNumber])
}

// Links contracts to multiple projects
model ProjectContract {
  id                    String          @id @default(cuid())
  contractId            String
  projectId             String
  allocatedAmount       Float?          // Amount allocated from contract to this project
  notes                 String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  contract              VendorContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  project               Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([contractId, projectId])
  @@index([contractId])
  @@index([projectId])
}

// Contract file attachments
model ContractDocument {
  id                    String          @id @default(cuid())
  contractId            String
  fileName              String
  fileSize              Int
  mimeType              String
  url                   String
  uploadedById          String?         // Optional - can be null if uploaded by vendor
  createdAt             DateTime        @default(now())

  contract              VendorContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
}

// Contract payments tracking
model ContractPayment {
  id                    String          @id @default(cuid())
  contractId            String
  amount                Float
  paymentDate           DateTime
  reference             String?         // Invoice/Check number
  notes                 String?
  createdById           String
  createdAt             DateTime        @default(now())

  contract              VendorContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  createdBy             User            @relation(fields: [createdById], references: [id])

  @@index([contractId])
  @@index([createdById])
  @@index([paymentDate])
}

// ===========================================
// ASSET MANAGEMENT
// ===========================================

enum AssetType {
  VEHICLE
  EQUIPMENT
  TOOL
}

enum AssetStatus {
  AVAILABLE
  IN_USE
  UNDER_MAINTENANCE
  RETIRED
  LOST_DAMAGED
}

enum AssetRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  RETURNED
}

enum MaintenanceType {
  ONE_TIME
  RECURRING
}

model Asset {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  type                  AssetType
  serialNumber          String?
  status                AssetStatus     @default(AVAILABLE)
  currentLocation       String?         // Current site/location
  currentAssigneeId     String?         // Currently assigned user
  purchaseCost          Float?
  purchaseDate          DateTime?
  warrantyExpiry        DateTime?
  photos                String?         // JSON array of photo URLs
  notes                 String?
  companyId             String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  company               Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  currentAssignee       User?           @relation("AssetCurrentAssignee", fields: [currentAssigneeId], references: [id])
  requests              AssetRequest[]
  maintenanceSchedules  MaintenanceSchedule[]
  maintenanceRecords    MaintenanceRecord[]

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@index([currentAssigneeId])
}

model AssetRequest {
  id                    String              @id @default(cuid())
  assetId               String
  requesterId           String
  projectId             String?             // Optional - which project it's needed for
  purpose               String              // Justification
  startDate             DateTime            // When asset is needed
  endDate               DateTime?           // Expected return date
  status                AssetRequestStatus  @default(PENDING)
  approvedById          String?             // Who approved (any authorized user)
  approvedAt            DateTime?
  rejectedById          String?
  rejectedAt            DateTime?
  rejectionReason       String?
  returnedAt            DateTime?
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  asset                 Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  requester             User                @relation("AssetRequester", fields: [requesterId], references: [id])
  approvedBy            User?               @relation("AssetApprover", fields: [approvedById], references: [id])
  rejectedBy            User?               @relation("AssetRejector", fields: [rejectedById], references: [id])
  project               Card?               @relation(fields: [projectId], references: [id])

  @@index([assetId])
  @@index([requesterId])
  @@index([status])
  @@index([projectId])
}

model MaintenanceSchedule {
  id                    String              @id @default(cuid())
  assetId               String
  title                 String
  description           String?
  type                  MaintenanceType     @default(ONE_TIME)
  intervalDays          Int?                // For recurring: interval in days
  nextDueDate           DateTime
  lastCompletedDate     DateTime?
  estimatedCost         Float?
  assignedToId          String?             // Who should perform the maintenance
  alertUserIds          String[]            @default([])
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  asset                 Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assignedTo            User?               @relation("MaintenanceAssignee", fields: [assignedToId], references: [id])
  records               MaintenanceRecord[]

  @@index([assetId])
  @@index([nextDueDate])
  @@index([isActive])
}

model MaintenanceRecord {
  id                    String              @id @default(cuid())
  assetId               String
  scheduleId            String?             // Optional - linked to a schedule
  title                 String
  description           String?
  performedDate         DateTime
  cost                  Float?
  performedById         String
  notes                 String?
  attachments           String?             // JSON array of file URLs
  createdAt             DateTime            @default(now())

  asset                 Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  schedule              MaintenanceSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  performedBy           User                @relation("MaintenancePerformer", fields: [performedById], references: [id])

  @@index([assetId])
  @@index([scheduleId])
  @@index([performedDate])
}

// ===========================================
// PROCUREMENT & INVENTORY MANAGEMENT
// ===========================================

// Item catalog for procurement
model ProcurementItem {
  id                    String              @id @default(cuid())
  name                  String
  description           String?
  category              String
  unit                  String              // e.g., "kg", "piece", "meter"
  defaultCost           Float?
  sku                   String?
  photos                String?             // JSON array of URLs
  complianceInfo        String?             // Compliance/certification details
  companyId             String
  preferredVendorId     String?
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  preferredVendor       Vendor?             @relation("PreferredVendorItems", fields: [preferredVendorId], references: [id], onDelete: SetNull)
  inventoryEntries      InventoryEntry[]
  priceComparisons      PriceComparison[]
  purchaseOrderItems    PurchaseOrderItem[]
  boqItems              BOQItem[]

  @@index([companyId])
  @@index([category])
  @@index([preferredVendorId])
  @@unique([companyId, sku])
}

// Tracks inventory per project
model InventoryEntry {
  id                    String              @id @default(cuid())
  itemId                String
  projectId             String
  purchasedQty          Float               @default(0)
  usedQty               Float               @default(0)
  // remainingQty computed as: purchasedQty - usedQty
  minStockLevel         Float?              // For low stock alerts
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  item                  ProcurementItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  project               Card                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  purchases             InventoryPurchase[]
  usageRecords          InventoryUsage[]

  @@unique([itemId, projectId])
  @@index([itemId])
  @@index([projectId])
}

// Records purchases against inventory
model InventoryPurchase {
  id                    String              @id @default(cuid())
  inventoryId           String
  quantity              Float
  unitCost              Float
  totalCost             Float
  supplierId            String?             // Optional link to vendor
  invoiceNumber         String?
  purchaseDate          DateTime
  notes                 String?
  recordedById          String
  createdAt             DateTime            @default(now())

  inventory             InventoryEntry      @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  supplier              Vendor?             @relation(fields: [supplierId], references: [id])
  recordedBy            User                @relation(fields: [recordedById], references: [id])

  @@index([inventoryId])
  @@index([purchaseDate])
  @@index([supplierId])
}

// Records usage of inventory items
model InventoryUsage {
  id                    String              @id @default(cuid())
  inventoryId           String
  quantity              Float
  usageDate             DateTime
  usedFor               String?             // Description of usage
  recordedById          String
  createdAt             DateTime            @default(now())

  inventory             InventoryEntry      @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  recordedBy            User                @relation(fields: [recordedById], references: [id])

  @@index([inventoryId])
  @@index([usageDate])
}

// Price comparisons from different vendors (also serves as vendor catalog)
model PriceComparison {
  id                    String              @id @default(cuid())
  itemId                String
  vendorId              String
  unitPrice             Float
  minQuantity           Float?
  validFrom             DateTime?
  validUntil            DateTime?
  notes                 String?
  isPreferred           Boolean             @default(false)
  leadTimeDays          Int?
  vendorSku             String?
  lastPurchaseDate      DateTime?
  totalPurchasedQty     Float               @default(0)
  totalPurchasedValue   Float               @default(0)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  item                  ProcurementItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  vendor                Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([itemId, vendorId])
  @@index([itemId])
  @@index([vendorId])
  @@index([isPreferred])
}

// Configuration for low stock alerts
model StockAlertConfig {
  id                    String              @id @default(cuid())
  companyId             String
  itemId                String?             // null = global setting
  projectId             String?             // null = all projects
  recipientIds          String              // JSON array of user IDs to alert
  threshold             Float?              // Override default threshold
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([itemId])
}

// ===========================================
// PURCHASE ORDERS
// ===========================================

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id                    String              @id @default(cuid())
  orderNumber           String
  vendorId              String
  projectId             String?
  status                PurchaseOrderStatus @default(DRAFT)
  subtotal              Float
  tax                   Float               @default(0)
  shipping              Float               @default(0)
  total                 Float
  expectedDeliveryDate  DateTime?
  deliveredDate         DateTime?
  notes                 String?
  terms                 String?
  companyId             String
  createdById           String
  approvedById          String?
  approvedAt            DateTime?
  sentAt                DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  vendor                Vendor              @relation(fields: [vendorId], references: [id])
  project               Card?               @relation(fields: [projectId], references: [id], onDelete: SetNull)
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy             User                @relation("POCreator", fields: [createdById], references: [id])
  approvedBy            User?               @relation("POApprover", fields: [approvedById], references: [id])
  lineItems             PurchaseOrderItem[]
  boqFulfillments       BOQPurchaseOrder[]

  @@unique([companyId, orderNumber])
  @@index([vendorId])
  @@index([projectId])
  @@index([companyId])
  @@index([status])
}

model PurchaseOrderItem {
  id                    String              @id @default(cuid())
  purchaseOrderId       String
  itemId                String
  quantity              Float
  unitPrice             Float
  total                 Float
  receivedQuantity      Float               @default(0)
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  purchaseOrder         PurchaseOrder       @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item                  ProcurementItem     @relation(fields: [itemId], references: [id])

  @@index([purchaseOrderId])
  @@index([itemId])
}

// ===========================================
// EMAIL CONFIGURATION
// ===========================================

enum EmailProvider {
  NONE
  SENDGRID
  AWS_SES
  SMTP
  RESEND
}

// Company-level email service configuration
model EmailConfig {
  id                    String              @id @default(cuid())
  companyId             String              @unique
  provider              EmailProvider       @default(NONE)
  apiKey                String?             // Encrypted API key
  fromEmail             String?
  fromName              String?
  // SMTP-specific fields
  smtpHost              String?
  smtpPort              Int?
  smtpUser              String?
  smtpPassword          String?             // Encrypted
  smtpSecure            Boolean             @default(true)
  // Status
  isActive              Boolean             @default(false)
  lastTestedAt          DateTime?
  testError             String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// ===========================================
// BILL OF QUANTITIES (BOQ)
// ===========================================

// Bill of Quantities line items
model BOQItem {
  id                    String          @id @default(cuid())
  itemNumber            String          // e.g., "1.1", "1.2", "2.1"
  name                  String
  description           String?
  category              String          // Trade/Work Package (e.g., "Site Work", "Concrete")
  subCategory           String?
  unit                  String          // e.g., "m3", "sq ft", "lump sum"
  quantity              Float
  unitRate              Float           // Estimated unit cost
  totalCost             Float           // Computed: quantity  unitRate
  actualCost            Float?          // Manual entry of actual cost (optional)

  // Procurement Integration
  procurementItemId     String?
  procurementItem       ProcurementItem? @relation(fields: [procurementItemId], references: [id], onDelete: SetNull)

  // Metadata
  notes                 String?
  specifications        String?
  order                 Int             @default(0)
  isContingency         Boolean         @default(false)

  // Relations
  projectId             String
  project               Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdById           String
  createdBy             User            @relation("BOQCreator", fields: [createdById], references: [id])
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  purchaseOrders        BOQPurchaseOrder[]

  @@index([projectId])
  @@index([category])
  @@index([procurementItemId])
  @@unique([projectId, itemNumber])
}

// Junction table to track BOQ items fulfilled by Purchase Orders
model BOQPurchaseOrder {
  id                    String          @id @default(cuid())
  boqItemId             String
  purchaseOrderId       String
  quantityFulfilled     Float
  unitCostActual        Float
  notes                 String?
  createdAt             DateTime        @default(now())

  boqItem               BOQItem         @relation(fields: [boqItemId], references: [id], onDelete: Cascade)
  purchaseOrder         PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@unique([boqItemId, purchaseOrderId])
  @@index([boqItemId])
  @@index([purchaseOrderId])
}

// BOQ Version/Revision tracking
model BOQRevision {
  id                    String          @id @default(cuid())
  projectId             String
  revisionNumber        Int
  description           String?
  totalEstimated        Float
  createdById           String
  createdBy             User            @relation("BOQRevisionCreator", fields: [createdById], references: [id])
  createdAt             DateTime        @default(now())
  snapshotData          String?         // JSON snapshot of BOQ at revision

  project               Card            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@unique([projectId, revisionNumber])
}

// ===========================================
// INVENTORY MANAGEMENT (Materials)
// ===========================================

model InventoryCategory {
  id                    String              @id @default(cuid())
  name                  String
  description           String?
  color                 String              @default("#6366f1")
  companyId             String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  materials             InventoryMaterial[]

  @@unique([companyId, name])
  @@index([companyId])
}

model InventoryMaterial {
  id                    String              @id @default(cuid())
  name                  String
  sku                   String?
  description           String?
  categoryId            String?
  unit                  String              // e.g., "pcs", "kg", "m", "sqft"
  quantity              Float               @default(0)
  unitCost              Float               @default(0)
  companyId             String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  category              InventoryCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions          InventoryTransaction[]

  @@unique([companyId, sku])
  @@index([companyId])
  @@index([categoryId])
}

enum InventoryTransactionType {
  STOCK_IN
  STOCK_OUT
}

model InventoryTransaction {
  id                    String                    @id @default(cuid())
  materialId            String
  type                  InventoryTransactionType
  quantity              Float
  previousQty           Float                     // Quantity before transaction
  newQty                Float                     // Quantity after transaction
  reason                String?                   // Notes/reason for the transaction
  projectId             String?                   // Optional - if allocated to a project
  userId                String
  createdAt             DateTime                  @default(now())

  material              InventoryMaterial         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project               Card?                     @relation("InventoryProjectAllocation", fields: [projectId], references: [id], onDelete: SetNull)
  user                  User                      @relation(fields: [userId], references: [id])

  @@index([materialId])
  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}